<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhatsApp Smart Redirect</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root { --bg:#0b1220; --text:#e6eefb; --muted:#9db0cc; --link:#9cc0ff }
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--text); display:grid; place-items:center}
    main{max-width:720px; padding:24px; text-align:center}
    a{color:var(--link)}
    .muted{color:var(--muted); font-size:.95rem}
  </style>
</head>
<body>
  <main>
    <h1>Weiterleitung zu WhatsApp…</h1>
    <p class="muted">Falls nichts passiert, tippe hier: 
      <a id="manualPrimary" href="#" rel="noopener">Primärer Link</a> · 
      <a id="manualStore" href="#" rel="noopener" target="_blank">App installieren</a>
    </p>
    <noscript>
      <p>JavaScript ist deaktiviert. Öffne stattdessen: <br>
      <a href="https://api.whatsapp.com/" rel="noopener">https://api.whatsapp.com/</a></p>
    </noscript>
  </main>

  <script>
    (function(){
      // --- UA-Erkennung ---
      const U = navigator.userAgent || '';
      const isAndroid = /Android/i.test(U);
      const isiOS     = /iPhone|iPad|iPod/i.test(U);
      // Android-WebView: erkennbar an "; wv)" oder typischer WebView-Signatur
      const isAndroidWebView = isAndroid && (/; wv\)/i.test(U) || /Version\/[\d.]+\s*Chrome\/[\d.]+\s*Mobile\s*Safari\/[\d.]+/i.test(U));

      // --- Parameter ---
      const qs = new URLSearchParams(location.search);
      const PHONE = (qs.get('phone') || '4915170086074').replace(/\s|\+/g,'');
      const TEXT  = (qs.get('text')  || '').trim();

      function apiUrl(phone, text){
        const base = 'https://api.whatsapp.com/send?phone=' + encodeURIComponent(phone);
        return text ? base + '&text=' + encodeURIComponent(text) : base;
      }
      function intentUrl(phone, text){
        const q = 'phone=' + encodeURIComponent(phone) + (text ? '&text=' + encodeURIComponent(text) : '');
        return 'intent://send?' + q + '#Intent;scheme=whatsapp;package=com.whatsapp;end';
      }
      function storeUrl(){
        if (isAndroid) return 'https://play.google.com/store/apps/details?id=com.whatsapp';
        if (isiOS)     return 'https://apps.apple.com/app/whatsapp-messenger/id310633997';
        return 'https://www.whatsapp.com/download';
      }

      // Manuelle Fallback-Links setzen
      const manualPrimary = document.getElementById('manualPrimary');
      const manualStore   = document.getElementById('manualStore');
      if (manualPrimary) manualPrimary.href = (isAndroid && !isAndroidWebView) ? intentUrl(PHONE, TEXT) : apiUrl(PHONE, TEXT);
      if (manualStore)   manualStore.href   = storeUrl();

      // --- Auto-Redirect-Strategie ---
      if (isAndroidWebView) {
        // In-App-Android-WebView mag intent:// nicht. Versuche zuerst externen Tab.
        const target = apiUrl(PHONE, TEXT);
        // 1) Versuch: in neuem Tab/Fenster (viele WebViews leiten so in Chrome aus)
        const win = window.open(target, '_blank');
        if (win) {
          // Falls Popup erlaubt, verlassen wir die Seite still
          return;
        }
        // 2) Fallback: gleiches Fenster
        location.replace(target);
        return;
      }

      if (isAndroid) {
        // Normaler Android-Browser: intent direkt
        const tryIntent = intentUrl(PHONE, TEXT);
        const fallbackTimer = setTimeout(function(){ location.replace(storeUrl()); }, 1500);
        try { location.replace(tryIntent); }
        catch(_) {
          clearTimeout(fallbackTimer);
          location.replace(storeUrl());
        }
        setTimeout(function(){ try{ clearTimeout(fallbackTimer); }catch(e){} }, 3500);
        return;
      }

      // iOS & andere
      location.replace(apiUrl(PHONE, TEXT));
    })();
  </script>
</body>
</html>
